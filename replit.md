# Система управления обращениями граждан для партии "Новые Люди"

## Обзор проекта

Веб-приложение для управления обращениями граждан в Чувашской Республике для политической партии "Новые Люди". Система позволяет гражданам подавать обращения без регистрации, а администраторам и модераторам - управлять этими обращениями через панель управления.

## Текущее состояние (25 ноября 2025)

### Последние изменения (25 ноября 2025):
- ✅ **История изменений (AppealHistory)** - отслеживание всех изменений обращений (статус, теги, комментарии)
- ✅ **Файлы в комментариях** - поддержка вложений в комментариях модераторов
- ✅ **Расширенная статистика** - статистика по тегам и среднее время обработки
- ✅ **Поиск обращений** - поиск по имени, email, тексту и комментариям
- ✅ **Исправлены теги и комментарии** - правильное отображение is_public, удален is_internal
- ✅ **Безопасность файлов** - защита от path traversal и обязательная аутентификация
- ✅ **Сохранение аудиторского следа** - история сохраняется при удалении пользователей

### Завершенные задачи:
- ✅ Установлены Python 3.11 и Node.js 20
- ✅ Создан FastAPI backend с PostgreSQL базой данных
- ✅ Реализована JWT аутентификация с ролями (admin/moderator)
- ✅ Созданы модели для обращений, категорий, тегов, пользователей, комментариев, истории
- ✅ Настроен React + Vite + TypeScript frontend
- ✅ Установлены зависимости: Tailwind CSS, Framer Motion, React Router, axios
- ✅ Оба сервера запущены и работают
- ✅ База данных инициализирована с тестовыми данными

### Готово к использованию:
- ✅ Публичная форма подачи обращений с dropdown меню для категорий
- ✅ Страница авторизации с автоматическим перенаправлением по ролям
- ✅ Панель модератора с поиском, фильтрами по статусу и категориям (/moderator)
- ✅ Панель администратора с статистикой, управлением категориями, тегами и пользователями (/admin)
- ✅ Просмотр истории изменений обращения в детальном виде
- ✅ Прикрепление и скачивание файлов в обращениях и комментариях
- ✅ Базовые анимации Framer Motion на всех страницах
- ✅ База данных инициализирована с тестовыми данными

### Следующие шаги:
- Интеграция логотипа партии в header
- Экспорт отчетов и аналитика
- Настройка email уведомлений

## Технологический стек

### Backend
- **Framework**: FastAPI
- **Database**: SQLite (citizens_appeals.db)
- **ORM**: SQLAlchemy
- **Authentication**: JWT (python-jose, bcrypt 4.0.1)
- **Validation**: Pydantic
- **Server**: Uvicorn

### Frontend
- **Framework**: React 18 + TypeScript
- **Build Tool**: Vite 7
- **Styling**: Tailwind CSS
- **Animations**: Framer Motion
- **Routing**: React Router DOM
- **HTTP Client**: axios
- **Forms**: react-hook-form
- **File Upload**: react-dropzone
- **Charts**: Recharts

## Структура проекта

```
├── backend/
│   ├── app/
│   │   ├── core/         # Конфигурация, БД, безопасность
│   │   ├── models/       # SQLAlchemy модели
│   │   ├── routers/      # API endpoints
│   │   ├── schemas/      # Pydantic схемы
│   │   └── services/     # Бизнес-логика
│   ├── uploads/          # Загруженные файлы
│   ├── main.py          # Точка входа FastAPI
│   ├── init_db.py       # Инициализация БД с тестовыми данными
│   └── requirements.txt
├── frontend/
│   ├── src/
│   │   ├── assets/      # Статические файлы
│   │   ├── App.tsx      # Главный компонент
│   │   └── main.tsx     # Точка входа
│   ├── vite.config.ts   # Конфигурация Vite
│   └── package.json
└── attached_assets/
    └── Logo_of_the_New_People_(political_party).svg_1764065114896.png
```

## API Endpoints

### Authentication
- `POST /api/auth/login` - Вход в систему (получение JWT токена)
- `GET /api/auth/me` - Получить информацию о текущем пользователе

### Appeals (Обращения)
- `GET /api/appeals` - Получить все обращения (требует аутентификации)
- `POST /api/appeals` - Создать новое обращение (публичный доступ)
- `GET /api/appeals/{id}` - Получить обращение по ID
- `PUT /api/appeals/{id}` - Обновить статус обращения (требует роли)
- `POST /api/appeals/{id}/comments` - Добавить комментарий с вложениями
- `GET /api/appeals/{id}/history` - История изменений обращения
- `GET /api/appeals/search?q=query` - Поиск обращений
- `GET /api/appeals/files/{filename}` - Скачивание файла (требует аутентификации)
- `POST /api/appeals/{id}/tags/{tag_type}/{tag_id}` - Добавить тег к обращению
- `DELETE /api/appeals/{id}/tags/{tag_type}/{tag_id}` - Удалить тег с обращения

### Statistics (Статистика)
- `GET /api/stats` - Полная статистика (общее количество, по статусам, категориям, тегам, среднее время)

### Categories (Категории)
- `GET /api/categories` - Получить все категории (иерархическая структура)
- `POST /api/categories` - Создать категорию (только admin)
- `PUT /api/categories/{id}` - Обновить категорию (только admin)
- `DELETE /api/categories/{id}` - Удалить категорию (только admin)

### Tags (Теги)
- `GET /api/tags` - Получить все теги (требует аутентификации)
- `GET /api/tags/public` - Получить публичные теги
- `GET /api/tags/internal` - Получить внутренние теги (требует аутентификации)
- `POST /api/tags/public` - Создать публичный тег (только admin)
- `POST /api/tags/internal` - Создать внутренний тег (только admin)
- `DELETE /api/tags/public/{id}` - Удалить публичный тег (только admin)
- `DELETE /api/tags/internal/{id}` - Удалить внутренний тег (только admin)

### Users (Пользователи)
- `GET /api/users` - Получить всех пользователей (только admin)
- `POST /api/users` - Создать пользователя (только admin)
- `DELETE /api/users/{id}` - Удалить пользователя (только admin)

## База данных

### Модели:
- **User**: Пользователи системы (администраторы и модераторы)
- **Category**: Иерархические категории обращений
- **PublicTag / InternalTag**: Публичные и внутренние теги для классификации
- **Appeal**: Обращения граждан с вложениями
- **Comment**: Комментарии к обращениям с вложениями
- **AppealHistory**: История изменений обращений (статус, теги, комментарии)

## Учетные записи для тестирования

### Администратор
- Username: `admin`
- Password: `admin123`
- Role: admin

### Модератор
- Username: `moderator`
- Password: `moderator123`
- Role: moderator

## Дизайн

### Цветовая схема
- Основной цвет: **Бирюзовый** (#00C9C8)
- Дополнительный: **Белый** (#FFFFFF)
- Акценты: Градиенты бирюзового

### Анимации
- Fade-in/out эффекты
- Slide transitions
- Hover состояния
- Модальные окна с плавным появлением
- Smooth transitions на всех элементах

## Переменные окружения

### Backend (.env)
```
DATABASE_URL=<PostgreSQL connection string>
SECRET_KEY=<JWT secret key>
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=30
```

### Frontend
Прокси API запросы настроен в `vite.config.ts`:
- `/api` → `http://127.0.0.1:8000`

## Workflows

### Backend API
- Команда: `cd backend && uvicorn main:app --host 0.0.0.0 --port 8000 --reload`
- Порт: 8000
- Тип: console

### Frontend App
- Команда: `cd frontend && npm run dev`
- Порт: 5000
- Тип: webview (публичный доступ через proxy)

## Безопасность

- JWT токены с bcrypt хэшированием паролей
- Role-based access control (RBAC)
- Защищенные роуты требуют аутентификации
- Административные операции требуют роли admin
- Загрузка файлов изолирована в `/uploads` с UUID именами

## Рекомендации архитектора

1. **⚠️ ВАЖНО**: Изменить пароли admin/moderator перед развертыванием в production
2. Вынести `SECRET_KEY` в переменные окружения для production
3. Добавить валидацию загружаемых файлов (размер/тип)
4. Реализовать автоматические API тесты для регрессионного тестирования
5. Добавить механизм сброса пароля при первом входе для учетных записей по умолчанию

## Предпочтения пользователя

- Использование FastAPI обязательно
- PostgreSQL вместо SQLite3 (из-за DATABASE_URL в окружении)
- Бирюзово-белая цветовая схема
- Обширные анимации на всех элементах интерфейса
- Многоуровневая иерархическая навигация по категориям
